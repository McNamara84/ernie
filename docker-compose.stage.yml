services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: app
    container_name: dockerized-laravel-app
    restart: unless-stopped
    volumes:
      - storage-data:/var/www/html/storage
      - bootstrap-cache:/var/www/html/bootstrap/cache
    networks:
      - dockerized-laravel-network
    depends_on:
      - db
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9000"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    environment:
      - APP_KEY=${APP_KEY}
      - APP_URL=https://ernie.rz-vm182.gfz.de
      - APP_ENV=production
      - APP_DEBUG=false
      - INERTIA_SSR_ENABLED=false
      - DATACITE_ENDPOINT=${DATACITE_ENDPOINT:-https://api.datacite.org}
      - DATACITE_CLIENT_ID=${DATACITE_CLIENT_ID:-tib.gfz}
      - DATACITE_USERNAME=${DATACITE_USERNAME}
      - DATACITE_PASSWORD=${DATACITE_PASSWORD}
      - SESSION_DRIVER=file
      - SESSION_LIFETIME=120
      - SESSION_PATH=/
      - SESSION_DOMAIN=ernie.rz-vm182.gfz.de
      - SESSION_SECURE_COOKIE=true
      - SESSION_SAME_SITE=lax
      - DB_HOST=db
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - BROADCAST_DRIVER=log
      - CACHE_STORE=redis
      - QUEUE_CONNECTION=database
      - SANCTUM_STATEFUL_DOMAINS=ernie.rz-vm182.gfz.de
      - DB_SUMARIOPMD_HOST=${DB_SUMARIOPMD_HOST}
      - DB_SUMARIOPMD_PORT=${DB_SUMARIOPMD_PORT:-3306}
      - DB_SUMARIOPMD_NAME=${DB_SUMARIOPMD_NAME}
      - DB_SUMARIOPMD_USER=${DB_SUMARIOPMD_USER}
      - DB_SUMARIOPMD_PASSWORD=${DB_SUMARIOPMD_PASSWORD}
      # Mail configuration
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@gfz-potsdam.de}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-ERNIE}

  webserver:
    build:
      context: .
      dockerfile: Dockerfile
      target: nginx
    container_name: dockerized-laravel-webserver
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      - storage-data:/var/www/html/storage:ro
    networks:
      - dockerized-laravel-network
      - traefik
    depends_on:
      app:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Router for the application (subdomain-based, no prefix needed)
      - "traefik.http.routers.ernie-router.rule=Host(`ernie.rz-vm182.gfz.de`)"
      - "traefik.http.routers.ernie-router.entrypoints=https"
      - "traefik.http.routers.ernie-router.service=ernie-service"
      # Service
      - "traefik.http.services.ernie-service.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik"

  db:
    image: mysql:8.0
    container_name: dockerized-laravel-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MARIADB_DATABASE}
      - MYSQL_USER=${MARIADB_USER}
      - MYSQL_PASSWORD=${MARIADB_PASSWORD}
    volumes:
      - dockerized-laravel-data:/var/lib/mysql
    networks:
      - dockerized-laravel-network
    ports:
      - "3306:3306"

  redis:
    image: redis:alpine
    container_name: dockerized-laravel-redis
    restart: unless-stopped
    networks:
      - dockerized-laravel-network
    ports:
      - "6379:6379"

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: ernie-cloudbeaver-stage
    restart: unless-stopped
    volumes:
      - cloudbeaver-workspace:/opt/cloudbeaver/workspace
      - ./docker/cloudbeaver/setup-connections.sh:/docker-entrypoint-initdb.d/setup-connections.sh:ro
    networks:
      - dockerized-laravel-network
      - traefik
    depends_on:
      - db
    environment:
      - CB_SERVER_NAME=ERNIE Database Admin
      - CB_ADMIN_NAME=cbadmin
      - CB_ADMIN_PASSWORD=${CLOUDBEAVER_ADMIN_PASSWORD:-ChangeMe123!}
      - CLOUDBEAVER_APP_ANONYMOUS_ACCESS_ENABLED=false
      - CLOUDBEAVER_APP_SUPPORTS_CUSTOM_CONNECTIONS=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ernie-cloudbeaver.rule=Host(`db.ernie.rz-vm182.gfz.de`)"
      - "traefik.http.routers.ernie-cloudbeaver.entrypoints=https"
      - "traefik.http.routers.ernie-cloudbeaver.service=ernie-cloudbeaver-service"
      - "traefik.http.services.ernie-cloudbeaver-service.loadbalancer.server.port=8978"
      - "traefik.docker.network=traefik"

  queue:
    build:
      context: .
      dockerfile: Dockerfile
      target: app
    container_name: dockerized-laravel-queue
    restart: unless-stopped
    command: php artisan queue:work --verbose --tries=3 --timeout=90
    volumes:
      - storage-data:/var/www/html/storage
      - bootstrap-cache:/var/www/html/bootstrap/cache
    networks:
      - dockerized-laravel-network
    depends_on:
      - db
      - redis
    environment:
      - APP_KEY=${APP_KEY}
      - APP_URL=https://ernie.rz-vm182.gfz.de
      - APP_ENV=production
      - APP_DEBUG=false
      - INERTIA_SSR_ENABLED=false
      - DATACITE_ENDPOINT=${DATACITE_ENDPOINT:-https://api.datacite.org}
      - DATACITE_CLIENT_ID=${DATACITE_CLIENT_ID:-tib.gfz}
      - DATACITE_USERNAME=${DATACITE_USERNAME}
      - DATACITE_PASSWORD=${DATACITE_PASSWORD}
      - DB_HOST=db
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - CACHE_STORE=redis
      - QUEUE_CONNECTION=database
      # Mail configuration (needed for queued mail jobs)
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@gfz-potsdam.de}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-ERNIE}

networks:
  dockerized-laravel-network:
    driver: bridge
  traefik:
    external: true

volumes:
  dockerized-laravel-data:
    driver: local
  storage-data:
    driver: local
  bootstrap-cache:
    driver: local
  cloudbeaver-workspace:
    driver: local