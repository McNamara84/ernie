services:
  # Traefik Reverse Proxy - mirrors production environment
  # Serves application on https://localhost:3333 (no prefix)
  # On Windows: Docker provider disabled, uses static routes.yml
  traefik:
    image: traefik:v3.2
    container_name: ernie-traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.http.address=:80"
      - "--entrypoints.https.address=:443"
      - "--entrypoints.http.http.redirections.entrypoint.to=https"
      - "--entrypoints.http.http.redirections.entrypoint.scheme=https"
      - "--log.level=INFO"
    ports:
      - "3333:443"
      - "8080:8080"  # Traefik Dashboard
    volumes:
      - ./docker/traefik/certs:/etc/traefik/certs:ro
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - ernie-dev-network

  # Laravel App (PHP-FPM) - Development Mode
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: app
    container_name: ernie-app-dev
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      # Source code mounting for hot-reload
      - .:/var/www/html
      # Persist vendor/node_modules for better performance
      - ernie-vendor:/var/www/html/vendor
      - ernie-node-modules:/var/www/html/node_modules
      # PHP config
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - ernie-dev-network
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      # You can emulate production-style subdomains locally using e.g. https://ernie.localhost:3333
      # (certificate SAN already includes *.localhost). Override via ERNIE_DEV_HOST if needed.
      - APP_URL=https://${ERNIE_DEV_HOST:-ernie.localhost}:${ERNIE_DEV_HTTPS_PORT:-3333}
      - VITE_DEV_SERVER_URL=https://${ERNIE_DEV_HOST:-ernie.localhost}:${ERNIE_DEV_HTTPS_PORT:-3333}
      # =========================================================================
      # Session Configuration (Docker Development)
      # =========================================================================
      # SESSION_SECURE_COOKIE=false because self-signed certificates aren't trusted
      # WARNING: In production, SESSION_SECURE_COOKIE must be true!
      # =========================================================================
      - SESSION_DRIVER=database
      - SESSION_LIFETIME=120
      - SESSION_PATH=/
      # If you use a subdomain like ernie.localhost, set ERNIE_DEV_SESSION_DOMAIN=.localhost
      - SESSION_DOMAIN=${ERNIE_DEV_SESSION_DOMAIN:-ernie.localhost}
      - SESSION_SECURE_COOKIE=false
      - SESSION_SAME_SITE=lax
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=ernie
      - DB_USERNAME=ernie
      - DB_PASSWORD=secret
      - REDIS_HOST=redis
      - BROADCAST_DRIVER=log
      - CACHE_STORE=redis
      - QUEUE_CONNECTION=database
      # If you use a subdomain like ernie.localhost, set ERNIE_DEV_STATEFUL_DOMAINS=ernie.localhost:3333
      - SANCTUM_STATEFUL_DOMAINS=${ERNIE_DEV_STATEFUL_DOMAINS:-ernie.localhost:3333,localhost:3333}

  # Nginx Webserver
  webserver:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: nginx
    container_name: ernie-webserver-dev
    restart: unless-stopped
    volumes:
      - .:/var/www/html:ro
      - ./docker/nginx/conf.d/dev.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - ernie-dev-network
    depends_on:
      - app
    labels:
      - "traefik.enable=true"
      # Main application router (subdomain-based, no prefix)      # The broad regex allows localhost and any *.localhost subdomain for development flexibility.
      # This enables testing with different subdomains without config changes (e.g., ernie.localhost, test.localhost).      - "traefik.http.routers.ernie-router.rule=HostRegexp(`{host:localhost(:[0-9]+)?|[a-z0-9-]+\\.localhost(:[0-9]+)?}`)"
      - "traefik.http.routers.ernie-router.entrypoints=https"
      - "traefik.http.routers.ernie-router.service=ernie-service"
      - "traefik.http.routers.ernie-router.tls=true"
      # Service
      - "traefik.http.services.ernie-service.loadbalancer.server.port=80"

  # Vite Dev Server for Hot Module Replacement
  # Runs in app container as Wayfinder plugin requires php artisan
  vite:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: app
    container_name: ernie-vite-dev
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
      - ernie-vendor:/var/www/html/vendor
      - ernie-node-modules:/var/www/html/node_modules
    networks:
      - ernie-dev-network
    depends_on:
      db:
        condition: service_healthy
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_URL=https://${ERNIE_DEV_HOST:-ernie.localhost}:${ERNIE_DEV_HTTPS_PORT:-3333}
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=ernie
      - DB_USERNAME=ernie
      - DB_PASSWORD=secret
      - VITE_APP_NAME=ERNIE
      - VITE_DEV_SERVER_URL=https://${ERNIE_DEV_HOST:-ernie.localhost}:${ERNIE_DEV_HTTPS_PORT:-3333}
      - VITE_HMR_HOST=${ERNIE_DEV_HOST:-ernie.localhost}
      - VITE_HMR_PORT=${ERNIE_DEV_HTTPS_PORT:-3333}
      - VITE_USE_POLLING=true
    entrypoint: [""]
    command: ["/bin/sh", "/var/www/html/docker/vite-entrypoint.sh"]
    labels:
      - "traefik.enable=true"
      # Note: These labels are for documentation/reference only.
      # Actual routing is defined in docker/traefik/dynamic/routes.yml
      - "traefik.http.routers.ernie-vite.rule=Host(`localhost`) && PathPrefix(`/@vite`)"
      - "traefik.http.routers.ernie-vite.entrypoints=https"
      - "traefik.http.routers.ernie-vite.priority=200"
      - "traefik.http.routers.ernie-vite.service=ernie-vite-service"
      - "traefik.http.routers.ernie-vite.tls=true"
      - "traefik.http.services.ernie-vite-service.loadbalancer.server.port=5173"

  # MySQL Database
  db:
    image: mysql:8.0
    container_name: ernie-db-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootsecret
      MYSQL_DATABASE: ernie
      MYSQL_USER: ernie
      MYSQL_PASSWORD: secret
    volumes:
      - ernie-db-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - ernie-dev-network
    ports:
      - "${DB_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootsecret"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis for caching and sessions
  redis:
    image: redis:alpine
    container_name: ernie-redis-dev
    restart: unless-stopped
    networks:
      - ernie-dev-network
    ports:
      - "${REDIS_PORT:-6379}:6379"

  # Queue Worker
  queue:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: app
    container_name: ernie-queue-dev
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
      - ernie-vendor:/var/www/html/vendor
    networks:
      - ernie-dev-network
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=ernie
      - DB_USERNAME=ernie
      - DB_PASSWORD=secret
      - REDIS_HOST=redis
      - CACHE_STORE=redis
      - QUEUE_CONNECTION=database
    command: php artisan queue:work --sleep=3 --tries=3

networks:
  ernie-dev-network:
    driver: bridge

volumes:
  ernie-db-data:
    driver: local
  ernie-vendor:
    driver: local
  ernie-node-modules:
    driver: local
