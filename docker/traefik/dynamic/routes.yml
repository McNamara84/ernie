# Traefik Dynamic Configuration
# Static routing for ERNIE development environment

http:
  routers:
    # ==========================================================================
    # Vite HMR Routers (highest priority) - Development asset serving
    # Split into separate routers for better maintainability
    # ==========================================================================
    
    # Vite internal routes (without /ernie prefix)
    ernie-vite-internal:
      rule: "PathPrefix(`/@vite`) || PathPrefix(`/@fs`) || PathPrefix(`/@react-refresh`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # Node modules and source files (without /ernie prefix)
    ernie-vite-sources:
      rule: "PathPrefix(`/node_modules`) || PathPrefix(`/resources/js`) || PathPrefix(`/resources/css`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # Vite internal routes (with /ernie prefix)
    ernie-vite-prefixed-internal:
      rule: "PathPrefix(`/ernie/@vite`) || PathPrefix(`/ernie/@fs`)"
      entryPoints:
        - https
      priority: 200
      middlewares:
        - ernie-vite-stripprefix
      service: ernie-vite-service
      tls: {}

    # Source files with /ernie prefix (js, css, data)
    ernie-vite-prefixed-sources:
      rule: "PathPrefix(`/ernie/node_modules`) || PathPrefix(`/ernie/resources/js`) || PathPrefix(`/ernie/resources/css`) || PathPrefix(`/ernie/resources/data`)"
      entryPoints:
        - https
      priority: 200
      middlewares:
        - ernie-vite-stripprefix
      service: ernie-vite-service
      tls: {}

    # ==========================================================================
    # Application Routers
    # ==========================================================================

    # API router (higher priority) - for public API endpoints
    ernie-api:
      rule: "PathPrefix(`/ernie/api/v1`)"
      entryPoints:
        - https
      priority: 100
      middlewares:
        - ernie-stripprefix
      service: ernie-service
      tls: {}

    # Main web router with /ernie prefix
    ernie-router:
      rule: "PathPrefix(`/ernie`)"
      entryPoints:
        - https
      priority: 50
      middlewares:
        - ernie-stripprefix
      service: ernie-service
      tls: {}

    # Catch-all router for requests without /ernie prefix (login, register, etc.)
    # These are requests from Inertia/axios that don't include the prefix
    ernie-catchall:
      rule: "PathPrefix(`/`)"
      entryPoints:
        - https
      priority: 1
      service: ernie-service
      tls: {}

  middlewares:
    ernie-stripprefix:
      stripPrefix:
        prefixes:
          - "/ernie"
    
    ernie-vite-stripprefix:
      stripPrefix:
        prefixes:
          - "/ernie"

  services:
    ernie-service:
      loadBalancer:
        servers:
          - url: "http://ernie-webserver-dev:80"

    ernie-vite-service:
      loadBalancer:
        servers:
          - url: "http://ernie-vite-dev:5173"
