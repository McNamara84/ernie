# =============================================================================
# Traefik Dynamic Configuration for ERNIE Development
# =============================================================================
# Static routing configuration (Docker provider disabled on Windows)
#
# Router Priority Explanation:
# - 300: Vite routes (HMR + source serving)
# - 100: API routes (specific paths before general catch-all)
# -   1: Main application catch-all
#
# Higher priority = matched first. Vite assets must be served before
# the catch-all routes intercept them.
# =============================================================================

http:
  routers:
    # ==========================================================================
    # Vite Development Server Routers (Priority 300)
    # ==========================================================================
    # These routers handle Hot Module Replacement (HMR) and source file serving.
    # Split into separate routers for better maintainability and debugging.
    # ==========================================================================
    
    # Vite internal routes - HMR, filesystem access, React refresh
    # Priority 300: Highest - these are direct browser requests
    ernie-vite-internal:
      rule: "PathPrefix(`/@vite`) || PathPrefix(`/@fs`) || PathPrefix(`/@react-refresh`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # Development source files and node_modules
    # Priority 300: Same as above - direct browser requests
    ernie-vite-sources:
      rule: "PathPrefix(`/node_modules`) || PathPrefix(`/resources/js`) || PathPrefix(`/resources/css`) || PathPrefix(`/resources/data`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # ==========================================================================
    # Application Routers (Priority 100/50/1)
    # ==========================================================================

    # API router - public endpoints that don't require session
    # Priority 100: Higher than main app to handle API-specific logic
    ernie-api:
      rule: "PathPrefix(`/api/v1`)"
      entryPoints:
        - https
      priority: 100
      service: ernie-service
      tls: {}

    # Main web application router
    # Priority 1: Standard application routing (catch-all)
    ernie-router:
      rule: "PathPrefix(`/`)"
      entryPoints:
        - https
      priority: 1
      service: ernie-service
      tls: {}

  services:
    ernie-service:
      loadBalancer:
        servers:
          - url: "http://ernie-webserver-dev:80"

    ernie-vite-service:
      loadBalancer:
        servers:
          - url: "http://ernie-vite-dev:5173"
