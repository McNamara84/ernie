# =============================================================================
# Traefik Dynamic Configuration for ERNIE Development
# =============================================================================
# Static routing configuration (Docker provider disabled on Windows)
#
# Simple subdomain-based routing - no prefix handling needed
# =============================================================================

http:
  routers:
    # ==========================================================================
    # Vite Development Server Routers
    # ==========================================================================
    # These routers handle Hot Module Replacement (HMR) and source file serving.
    # Priority 200: Vite routes should be matched before the main app catch-all
    # ==========================================================================

    # Vite HMR websocket (default path is "/?token=...")
    # Must be routed before the main app router, otherwise Traefik will send it
    # to Laravel and the Vite client will crash on a non-101 response.
    ernie-vite-hmr-ws:
      rule: "Host(`localhost`) && HeaderRegexp(`Connection`, `(?i)(^|,\\s*)upgrade(\\s*,|$)`) && HeaderRegexp(`Upgrade`, `(?i)^websocket$`)"
      entryPoints:
        - https
      priority: 210
      service: ernie-vite-service
      tls: {}
    
    # Vite internal routes - HMR, filesystem access, React refresh
    ernie-vite-internal:
      rule: "PathPrefix(`/@vite`) || PathPrefix(`/@fs`) || PathPrefix(`/@react-refresh`)"
      entryPoints:
        - https
      priority: 200
      service: ernie-vite-service
      tls: {}

    # Development source files and node_modules
    ernie-vite-sources:
      rule: "PathPrefix(`/node_modules`) || PathPrefix(`/resources/js`) || PathPrefix(`/resources/css`) || PathPrefix(`/resources/data`)"
      entryPoints:
        - https
      priority: 200
      service: ernie-vite-service
      tls: {}

    # ==========================================================================
    # Main Application Router
    # ==========================================================================
    # Catch-all for all other requests - routes to Laravel application
    # ==========================================================================
    
    ernie-router:
      rule: "Host(`localhost`)"
      entryPoints:
        - https
      priority: 1
      service: ernie-service
      tls: {}

  services:
    ernie-service:
      loadBalancer:
        servers:
          - url: "http://ernie-webserver-dev:80"

    ernie-vite-service:
      loadBalancer:
        passHostHeader: false
        servers:
          - url: "http://ernie-vite-dev:5173"
