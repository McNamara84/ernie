# =============================================================================
# Traefik Dynamic Configuration for ERNIE Development
# =============================================================================
# Static routing configuration (Docker provider disabled on Windows)
#
# Router Priority Explanation:
# - 300: Vite routes WITHOUT /ernie prefix (direct browser requests)
# - 200: Vite routes WITH /ernie prefix (need strip-prefix middleware)
# - 100: API routes (specific paths before general catch-all)
# -  50: Main application with /ernie prefix
# -   1: Catch-all for Inertia/axios requests without prefix
#
# Higher priority = matched first. Vite assets must be served before
# the catch-all routes intercept them.
# =============================================================================

http:
  routers:
    # ==========================================================================
    # Vite Development Server Routers (Priority 300/200)
    # ==========================================================================
    # These routers handle Hot Module Replacement (HMR) and source file serving.
    # Split into separate routers for better maintainability and debugging.
    #
    # Priority 300: Direct requests (browser makes request without /ernie prefix)
    # Priority 200: Prefixed requests (need middleware to strip /ernie)
    # ==========================================================================
    
    # Vite internal routes - HMR, filesystem access, React refresh
    # Priority 300: Highest - these are direct browser requests
    ernie-vite-internal:
      rule: "PathPrefix(`/@vite`) || PathPrefix(`/@fs`) || PathPrefix(`/@react-refresh`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # Development source files and node_modules
    # Priority 300: Same as above - direct browser requests
    ernie-vite-sources:
      rule: "PathPrefix(`/node_modules`) || PathPrefix(`/resources/js`) || PathPrefix(`/resources/css`)"
      entryPoints:
        - https
      priority: 300
      service: ernie-vite-service
      tls: {}

    # Vite internal routes with /ernie prefix (from Laravel-generated URLs)
    # Priority 200: Lower than direct - needs prefix stripping
    ernie-vite-prefixed-internal:
      rule: "PathPrefix(`/ernie/@vite`) || PathPrefix(`/ernie/@fs`) || PathPrefix(`/ernie/@react-refresh`)"
      entryPoints:
        - https
      priority: 200
      middlewares:
        - ernie-vite-stripprefix
      service: ernie-vite-service
      tls: {}

    # Source files with /ernie prefix
    # Priority 200: Same as above - needs prefix stripping
    ernie-vite-prefixed-sources:
      rule: "PathPrefix(`/ernie/node_modules`) || PathPrefix(`/ernie/resources/js`) || PathPrefix(`/ernie/resources/css`) || PathPrefix(`/ernie/resources/data`)"
      entryPoints:
        - https
      priority: 200
      middlewares:
        - ernie-vite-stripprefix
      service: ernie-vite-service
      tls: {}

    # ==========================================================================
    # Application Routers (Priority 100/50/1)
    # ==========================================================================

    # API router - public endpoints that don't require session
    # Priority 100: Higher than main app to handle API-specific logic
    ernie-api:
      rule: "PathPrefix(`/ernie/api/v1`)"
      entryPoints:
        - https
      priority: 100
      middlewares:
        - ernie-stripprefix
      service: ernie-service
      tls: {}

    # Main web application router
    # Priority 50: Standard application routing
    ernie-router:
      rule: "PathPrefix(`/ernie`)"
      entryPoints:
        - https
      priority: 50
      middlewares:
        - ernie-stripprefix
      service: ernie-service
      tls: {}

    # Catch-all router for requests without /ernie prefix
    # Priority 1: Lowest - handles Inertia/axios requests that bypass prefix
    # These occur when JavaScript makes requests to relative URLs
    ernie-catchall:
      rule: "PathPrefix(`/`)"
      entryPoints:
        - https
      priority: 1
      service: ernie-service
      tls: {}

  middlewares:
    ernie-stripprefix:
      stripPrefix:
        prefixes:
          - "/ernie"
    
    ernie-vite-stripprefix:
      stripPrefix:
        prefixes:
          - "/ernie"

  services:
    ernie-service:
      loadBalancer:
        servers:
          - url: "http://ernie-webserver-dev:80"

    ernie-vite-service:
      loadBalancer:
        servers:
          - url: "http://ernie-vite-dev:5173"
