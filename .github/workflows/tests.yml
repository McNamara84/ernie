name: Pest PHP Unit Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    name: Pest PHP Tests - Shard ${{ matrix.shard }}/2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5
          tools: composer:v2
          coverage: xdebug

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm ci

      - name: Install Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Build Assets
        run: npm run build
        env:
          NODE_ENV: production
          APP_ENV: testing
          APP_URL: http://localhost
          ASSET_URL: http://localhost

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Configure test environment
        run: |
          sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=sqlite/' .env
          sed -i '/^DB_HOST=/d' .env
          sed -i '/^DB_PORT=/d' .env  
          sed -i '/^DB_DATABASE=/d' .env
          sed -i '/^DB_USERNAME=/d' .env
          sed -i '/^DB_PASSWORD=/d' .env
          sed -i 's/^SESSION_DRIVER=.*/SESSION_DRIVER=file/' .env
          sed -i 's/^CACHE_DRIVER=.*/CACHE_DRIVER=file/' .env
          sed -i 's/^CACHE_STORE=.*/CACHE_STORE=file/' .env
          sed -i 's/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=sync/' .env
          sed -i 's/^BROADCAST_CONNECTION=.*/BROADCAST_CONNECTION=log/' .env
          sed -i 's/^APP_ENV=.*/APP_ENV=testing/' .env
          sed -i 's/^APP_DEBUG=.*/APP_DEBUG=false/' .env
          sed -i 's/^APP_URL=.*/APP_URL=http:\/\/localhost/' .env
          sed -i 's/^ASSET_URL=.*/ASSET_URL=http:\/\/localhost/' .env
          mkdir -p database
          touch database/database.sqlite
          chmod 666 database/database.sqlite
          echo "=== .env configuration for tests ==="
          cat .env | grep -E "(APP_|DB_|SESSION_|CACHE_|QUEUE_|ASSET_|BROADCAST_)"
          echo "============================="

      - name: Setup database
        run: |
          php artisan config:clear
          php artisan cache:clear
          php artisan migrate:fresh --seed --force

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Debug Vite manifest
        run: |
          echo "=== Vite build output ==="
          ls -la public/build/ || echo "No build directory found"
          echo "=== Vite manifest content ==="
          cat public/build/manifest.json | head -30 || echo "No manifest found"
          echo "=== Total entries in manifest ==="
          grep -c '"file"' public/build/manifest.json || echo "Could not count entries"

      - name: Debug routing
        run: |
          echo "=== Available routes ==="
          php artisan route:list | head -20 || echo "Could not list routes"
          echo "=== Application configuration ==="
          php artisan config:show app.url || echo "Could not show app.url"

      - name: Tests
        run: ./vendor/bin/pest --shard=${{ matrix.shard }}/2